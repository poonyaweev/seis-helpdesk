<!DOCTYPE html>
<html>
<head>
  <title>Terms of Service</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .is-invalid {
      border-color: #dc3545 !important;
    }
    .invalid-feedback {
      color: #dc3545;
      font-size: 0.875em;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    function validateThaiID(id) {
      if (!/^\d{13}$/.test(id)) return false;
      
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += parseInt(id.charAt(i)) * (13 - i);
      }
      
      const checkDigit = (11 - (sum % 11)) % 10;
      return checkDigit === parseInt(id.charAt(12));
    }
    
    function showError(message) {
      const errorElement = document.getElementById('idError');
      errorElement.textContent = message;
      errorElement.style.display = 'block';
      return false;
    }
    
    function hideError() {
      const errorElement = document.getElementById('idError');
      errorElement.style.display = 'none';
      return true;
    }
    
    function formatID(id) {
      return id.replace(/\D/g, '');
    }
    
    function handleIDInput(e) {
      const input = e.target;
      let value = input.value.replace(/\D/g, '');
      
      // Limit to 13 digits
      if (value.length > 13) {
        value = value.slice(0, 13);
      }
      
      input.value = value;
      
      // Only validate when we have 13 digits
      if (value.length === 13) {
        if (!validateThaiID(value)) {
          showError('หมายเลขบัตรประชาชนไม่ถูกต้อง');
        } else {
          hideError();
        }
      } else if (value.length > 0) {
        showError('หมายเลขบัตรประชาชนต้องมี 13 หลัก');
      } else {
        hideError();
      }
    }
    
    async function loginWithSEIS(event) {
      event.preventDefault();
      
      const perCardNo = document.getElementById('perCardNo').value.trim();
      
      if (!perCardNo) {
        return showError('กรุณากรอกหมายเลขบัตรประชาชน');
      }
      
      // Validate Thai ID
      if (!validateThaiID(perCardNo)) {
        showError('หมายเลขบัตรประชาชนไม่ถูกต้อง');
        return;
      }
      
      try {
        const response = await axios.post('/api/seis-login', { perCardNo });
        
        // Store the API response in sessionStorage
        const userData = response.data;
        console.log('API Response:', userData);
        
        // Check if data is available
        if (!userData.data || !userData.data['0'] || !userData.data['0'].fullname) {
          alert('โปรดลงชื่อเข้าใช้งานระบบ SEIS ก่อนแจ้งปัญหา');
          return;
        }
        
        // Store user data in sessionStorage
        sessionStorage.setItem('userFullname', userData.data['0'].fullname);
        sessionStorage.setItem('userDepartment', userData.data['0'].deaprtment_name);
        sessionStorage.setItem('userIpAddress', userData.data['0'].last_ip);
        
        // Redirect to /create page after successful API call and data validation
        window.location.href = '/create';
        
      } catch (error) {
        console.error('Error calling SEIS API:', error);
        alert('เกิดข้อผิดพลาดในการเชื่อมต่อกับระบบ กรุณาลองใหม่อีกครั้ง');
      }
    }
  </script>
</head>
<body>
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">เงื่อนไขการใช้งาน</h3>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">โปรดอ่านเงื่อนไขต่อไปนี้ก่อนดำเนินการแจ้งปัญหา</p>
          
          <div class="form-group mb-4">
            <div class="form-control" style="height: 300px; overflow-y: auto;">
              <p>การกดปุ่ม "ลงชื่อเข้าใช้ด้วย SEIS" แสดงว่าคุณได้อ่านและยอมรับข้อกำหนดและเงื่อนไขเหล่านี้แล้ว</p>
              <ol>
                <li>โปรแกรมนี้จะเก็บหมายเลขบัตรประชาชน เบอร์โทรศัพท์ และ LINE ID ของคุณเพื่อใช้ในการอ้างอิง</li>
                <li>เจ้าหน้าที่ของเราอาจติดต่อคุณผ่านโทรศัพท์หรือ LINE เพื่อขอข้อมูลเพิ่มเติม</li>
              </ol>
            </div>
          </div>
          
          <div class="form-group mb-3">
            <label for="perCardNo" class="form-label">หมายเลขบัตรประชาชน <span class="text-danger">*</span></label>
            <input 
              type="text" 
              class="form-control" 
              id="perCardNo" 
              placeholder="กรอกหมายเลขบัตรประชาชน 13 หลัก" 
              pattern="\d{13}"
              maxlength="13"
              inputmode="numeric"
              oninput="handleIDInput(event)"
              required>
            <div id="idError" class="invalid-feedback" style="display: none;"></div>
            <small class="form-text text-muted">กรุณากรอกหมายเลขบัตรประชาชน 13 หลัก โดยไม่ต้องเว้นวรรคหรือขีด</small>
          </div>
          
          <div class="d-flex">
            <a href="/" class="btn btn-link">ปฏิเสธ</a>
            <button onclick="loginWithSEIS(event)" class="btn btn-primary ms-auto">ลงชื่อเข้าใช้ด้วย SEIS</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>